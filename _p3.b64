        const missingCriteria = tasks.filter(t => !t.acceptance_criteria || t.acceptance_criteria.trim().length === 0);
        if (missingCriteria.length > 0) { const ratio = missingCriteria.length / tasks.length; const severity: RiskFactor['severity'] = ratio > 0.5 ? 'high' : ratio > 0.2 ? 'medium' : 'low'; factors.push({ id: gid('risk'), category: 'scope', severity, probability: 0.6+ratio*0.3, impact: 0.5+ratio*0.3, riskScore: (0.6+ratio*0.3)*(0.5+ratio*0.3)*SW[severity], title: 'Missing acceptance criteria', description: `${missingCriteria.length} of ${tasks.length} tasks have no acceptance criteria.`, mitigation: 'Add clear, binary acceptance criteria to every task.', affectedTasks: missingCriteria.map(t => t.id) }); }
        const vagueDescriptions = tasks.filter(t => !t.description || t.description.trim().length < 20);
        if (vagueDescriptions.length > 0) { const ratio = vagueDescriptions.length / tasks.length; const severity: RiskFactor['severity'] = ratio > 0.5 ? 'high' : ratio > 0.2 ? 'medium' : 'low'; factors.push({ id: gid('risk'), category: 'scope', severity, probability: 0.5+ratio*0.3, impact: 0.4+ratio*0.3, riskScore: (0.5+ratio*0.3)*(0.4+ratio*0.3)*SW[severity], title: 'Vague task descriptions', description: `${vagueDescriptions.length} of ${tasks.length} tasks have descriptions shorter than 20 characters.`, mitigation: 'Expand descriptions to include what, why, and context.', affectedTasks: vagueDescriptions.map(t => t.id) }); }
        const oversized = tasks.filter(t => t.estimated_minutes > 45);
        if (oversized.length > 0) { const sev = oversized.some(t => t.estimated_minutes > 120) ? 'high' : 'medium'; factors.push({ id: gid('risk'), category: 'schedule', severity: sev, probability: 0.7, impact: 0.6, riskScore: 0.7*0.6*SW[sev], title: 'Oversized tasks detected', description: `${oversized.length} tasks exceed 45 minutes.`, mitigation: 'Decompose tasks >45 min into 15-45 min subtasks.', affectedTasks: oversized.map(t => t.id) }); }
        if (graph.maxDepth > 3) { const deepNodes = graph.nodes.filter(n => n.depth > 3); const sev = graph.maxDepth > 5 ? 'critical' : 'high'; factors.push({ id: gid('risk'), category: 'schedule', severity: sev, probability: 0.6, impact: 0.8, riskScore: 0.6*0.8*SW[sev], title: 'Deep dependency chains', description: `Maximum dependency depth is ${graph.maxDepth}.`, mitigation: 'Flatten the dependency graph.', affectedTasks: deepNodes.map(n => n.id) }); }
        if (graph.hasCycles) factors.push({ id: gid('risk'), category: 'technical', severity: 'critical', probability: 1.0, impact: 1.0, riskScore: 1.0*1.0*SW['critical'], title: 'Circular dependencies detected', description: `${graph.cycleNodes.length} tasks are involved in dependency cycles.`, mitigation: 'Break the cycles by removing or reversing at least one dependency.', affectedTasks: graph.cycleNodes });
