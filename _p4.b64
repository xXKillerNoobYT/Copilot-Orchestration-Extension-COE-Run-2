        const bottleneckNodes = graph.nodes.filter(n => n.outDegree > 3);
        for (const node of bottleneckNodes) { const sev = node.outDegree > 5 ? 'high' : 'medium'; factors.push({ id: gid('risk'), category: 'schedule', severity: sev, probability: 0.5, impact: 0.3+(node.outDegree/tasks.length), riskScore: 0.5*(0.3+(node.outDegree/tasks.length))*SW[sev], title: `Bottleneck: "${node.title}"`, description: `Task "${node.title}" has ${node.outDegree} tasks depending on it.`, mitigation: `Prioritize "${node.title}" for early completion.`, affectedTasks: [node.id] }); }
        const totalMinutes = tasks.reduce((sum, t) => sum + (t.estimated_minutes ?? 0), 0);
        const totalHours = totalMinutes / 60;
        if (totalHours > 80) { const sev = totalHours > 160 ? 'critical' : 'high'; factors.push({ id: gid('risk'), category: 'schedule', severity: sev, probability: 0.6, impact: 0.7, riskScore: 0.6*0.7*SW[sev], title: 'High total effort estimate', description: `Plan totals ${totalHours.toFixed(1)} hours of work.`, mitigation: 'Break the plan into incremental milestones.', affectedTasks: tasks.map(t => t.id) }); }
        const rawScore = factors.reduce((sum, f) => sum + f.riskScore, 0);
        const maxPossible = Math.max(factors.length * 4, 1);
        const overallScore = Math.min(100, Math.round((rawScore / maxPossible) * 100));
        const overallRisk: RiskAnalysis['overallRisk'] = overallScore >= 75 ? 'critical' : overallScore >= 50 ? 'high' : overallScore >= 25 ? 'medium' : 'low';
        const bottlenecks = graph.nodes.filter(n => n.outDegree > 0).sort((a, b) => b.outDegree - a.outDegree).slice(0, 5).map(n => ({ taskId: n.id, dependentCount: n.outDegree, blockingRisk: n.outDegree / tasks.length }));
        const recommendations: string[] = [];
        if (graph.hasCycles) recommendations.push('CRITICAL: Resolve dependency cycles before starting any work.');
        if (missingCriteria.length > 0) recommendations.push(`Add acceptance criteria to ${missingCriteria.length} tasks.`);
        if (oversized.length > 0) recommendations.push(`Decompose ${oversized.length} oversized tasks (>45 min).`);
        if (p1Ratio > 0.5) recommendations.push('Re-prioritize tasks: too many P1 tasks dilute focus.');
        if (graph.maxDepth > 3) recommendations.push('Flatten dependency chains to reduce cascading delay risk.');
        if (bottleneckNodes.length > 0) recommendations.push('Prioritize bottleneck tasks for early completion.');
        if (recommendations.length === 0) recommendations.push('Plan looks healthy. Proceed with execution.');
        return { overallRisk, riskScore: overallScore, factors, recommendations, criticalPath: graph.criticalPath, bottlenecks };
    }
